name: Terraform Deploy

on:
  push:
    branches:
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: gcp
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

      # Generate SSH Key Pair (Optional)
    - name: Generate SSH key
      run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -C "github-action@github.com"
          echo "Public Key:"
          cat ~/.ssh/id_rsa.pub

      # Add the private key to the SSH agent
    - name: Add SSH Key to the agent
      run: |
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

      # Set GCP credentials
    - name: Set GCP credentials
      id: auth
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
    
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_CREDENTIALS }}
        export_default_credentials: true

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.9.5

    - name: Initialize Terraform
      run: cd test && terraform init

    # Step 4: Install Checkov for security scanning
    - name: Install Checkov
      run: pip install checkov

    # Step 5: Run Checkov on Terraform code
    - name: Run Checkov to scan Terraform
      run: checkov -d .
      continue-on-error: true  # Allow Checkov to fail but continue workflow

    - name: Plan Terraform changes
      run: cd test && terraform plan
    
    - name: Apply Terraform changes
      run: cd test && terraform apply --auto-approve

# Uncomment if you want to add manual approval step
#   manual_approval:
#     runs-on: ubuntu-latest
#     needs: terraform
#     steps:
#         - name: Wait for approval
#           run: |
#             echo "Waiting for approval..."
#             sleep 300  # You can replace this with a real-time waiting step if needed
#   apply:
#     runs-on: ubuntu-latest
#     needs: manual_approval
#     steps:
#         - name: Terraform Apply
#           run: terraform apply --auto-approve
